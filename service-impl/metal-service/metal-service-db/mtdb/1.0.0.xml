<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <preConditions>
        <dbms type="postgresql"/>
        <sqlCheck expectedResult="1">SELECT COUNT(1) FROM pg_extension WHERE extname = 'uuid-ossp';</sqlCheck>
    </preConditions>

    <changeSet author="d.zaitsev" id="20170804-2">
        <comment>Создание таблицы информации об адресах</comment>
        <sql>
            CREATE TABLE mtsm.address
            (
            guid character varying(255) NOT NULL,
            last_editing_date timestamp without time zone NOT NULL,
            apartment character varying(255) COLLATE pg_catalog."default",
            building character varying(255) COLLATE pg_catalog."default",
            city character varying(255) COLLATE pg_catalog."default",
            district character varying(255) COLLATE pg_catalog."default",
            house_number character varying(255) COLLATE pg_catalog."default",
            letter character varying(255) COLLATE pg_catalog."default",
            phone_number character varying(255) COLLATE pg_catalog."default",
            region character varying(255) COLLATE pg_catalog."default",
            street character varying(255) COLLATE pg_catalog."default",
            CONSTRAINT address_pkey PRIMARY KEY (guid)
            );

            ALTER TABLE MTSM.ADDRESS owner to mt_user;
            GRANT SELECT, INSERT, UPDATE, DELETE ON MTSM.ADDRESS TO mt_user;
        </sql>
        <rollback>
            DROP TABLE MTSM.ADDRESS;
        </rollback>
    </changeSet>

    <changeSet author="d.zaitsev" id="20170804-3">
        <comment>Создание таблицы информации о банковских реквизитах</comment>
        <sql>
            CREATE TABLE mtsm.bank_requisites
            (
            guid character varying(255) COLLATE pg_catalog."default" NOT NULL,
            last_editing_date timestamp without time zone NOT NULL,
            account_1 character varying(255) COLLATE pg_catalog."default",
            account_2 character varying(255) COLLATE pg_catalog."default",
            bank_name character varying(255) COLLATE pg_catalog."default",
            bik character varying(255) COLLATE pg_catalog."default",
            inn character varying(255) COLLATE pg_catalog."default",
            kpp character varying(255) COLLATE pg_catalog."default",
            recipient_name character varying(255) COLLATE pg_catalog."default",
            CONSTRAINT bank_requisites_pkey PRIMARY KEY (guid)
            );

            ALTER TABLE MTSM.BANK_REQUISITES owner to mt_user;
            GRANT SELECT, INSERT, UPDATE, DELETE ON MTSM.BANK_REQUISITES TO mt_user;
        </sql>
        <rollback>
            DROP TABLE MTSM.BANK_REQUISITES;
        </rollback>
    </changeSet>

    <changeSet author="d.zaitsev" id="20170804-1">
        <comment>Создание таблицы информации об организации</comment>
        <sql>
            CREATE TABLE mtsm.organization_info
            (
            guid character varying(255) COLLATE pg_catalog."default" NOT NULL,
            last_editing_date timestamp without time zone NOT NULL,
            accountant character varying(255) COLLATE pg_catalog."default",
            director character varying(255) COLLATE pg_catalog."default",
            organization_name character varying(255) COLLATE pg_catalog."default",
            address_guid character varying(255) COLLATE pg_catalog."default",
            bank_req_guid character varying(255) COLLATE pg_catalog."default",
            CONSTRAINT organization_info_pkey PRIMARY KEY (guid),
            CONSTRAINT fk_address FOREIGN KEY (address_guid)
            REFERENCES mtsm.address (guid) MATCH SIMPLE
            ON UPDATE NO ACTION
            ON DELETE NO ACTION,
            CONSTRAINT fk_bank_req FOREIGN KEY (bank_req_guid)
            REFERENCES mtsm.bank_requisites (guid) MATCH SIMPLE
            ON UPDATE NO ACTION
            ON DELETE NO ACTION
            );

            ALTER TABLE MTSM.ORGANIZATION_INFO owner to mt_user;
            GRANT SELECT, INSERT, UPDATE, DELETE ON MTSM.ORGANIZATION_INFO TO mt_user;
        </sql>
        <rollback>
            DROP TABLE MTSM.ORGANIZATION_INFO;
        </rollback>
    </changeSet>

    <changeSet author="d.zaitsev" id="20170804-5">
        <comment>Создание таблицы групп товаров</comment>
        <sql>
            CREATE TABLE mtsm.groups
            (
            guid character varying(255) COLLATE pg_catalog."default" NOT NULL,
            last_editing_date timestamp without time zone NOT NULL,
            is_active boolean,
            group_guid character varying(255) COLLATE pg_catalog."default",
            group_name character varying(255) COLLATE pg_catalog."default",
            CONSTRAINT groups_pkey PRIMARY KEY (guid)
            );

            ALTER TABLE MTSM.groups owner to mt_user;
            GRANT SELECT, INSERT, UPDATE, DELETE ON MTSM.groups TO mt_user;
        </sql>
        <rollback>
            DROP TABLE MTSM.groups;
        </rollback>
    </changeSet>

    <changeSet author="d.zaitsev" id="20170804-6">
        <comment>Создание таблицы единиц измерения</comment>
        <sql>
            CREATE TABLE mtsm.okei
            (
            guid character varying(255) COLLATE pg_catalog."default" NOT NULL,
            last_editing_date timestamp without time zone NOT NULL,
            is_active boolean,
            name character varying(255) COLLATE pg_catalog."default",
            CONSTRAINT okei_pkey PRIMARY KEY (guid)
            );

            ALTER TABLE MTSM.okei owner to mt_user;
            GRANT SELECT, INSERT, UPDATE, DELETE ON MTSM.okei TO mt_user;
        </sql>
        <rollback>
            DROP TABLE MTSM.okei;
        </rollback>
    </changeSet>

    <changeSet author="d.zaitsev" id="20170804-4">
        <comment>Создание таблицы информации о товарах</comment>
        <sql>
            CREATE TABLE mtsm.goods
            (
            guid character varying(255) COLLATE pg_catalog."default" NOT NULL,
            last_editing_date timestamp without time zone NOT NULL,
            is_active boolean,
            name character varying(255) COLLATE pg_catalog."default",
            group_guid character varying(255) COLLATE pg_catalog."default" NOT NULL,
            okei_guid character varying(255) COLLATE pg_catalog."default" NOT NULL,
            CONSTRAINT goods_pkey PRIMARY KEY (guid),
            CONSTRAINT fk_okei_good FOREIGN KEY (okei_guid)
            REFERENCES mtsm.okei (guid) MATCH SIMPLE
            ON UPDATE NO ACTION
            ON DELETE NO ACTION,
            CONSTRAINT fk_group_guid FOREIGN KEY (group_guid)
            REFERENCES mtsm.groups (guid) MATCH SIMPLE
            ON UPDATE NO ACTION
            ON DELETE NO ACTION
            );

            ALTER TABLE MTSM.goods owner to mt_user;
            GRANT SELECT, INSERT, UPDATE, DELETE ON MTSM.goods TO mt_user;
        </sql>
        <rollback>
            DROP TABLE MTSM.goods;
        </rollback>
    </changeSet>
    <changeSet author="d.zaitsev" id="20170804-7">
        <comment>заполнение справочника okei</comment>
        <sql>
            INSERT INTO mtsm.okei(guid, last_editing_date, is_active, name) VALUES (uuid_generate_v4(), now(), true, 'шт');
            INSERT INTO mtsm.okei(guid, last_editing_date, is_active, name) VALUES (uuid_generate_v4(), now(), true, 'тн');
            INSERT INTO mtsm.okei(guid, last_editing_date, is_active, name) VALUES (uuid_generate_v4(), now(), true, 'лист');
            INSERT INTO mtsm.okei(guid, last_editing_date, is_active, name) VALUES (uuid_generate_v4(), now(), true, 'м');
        </sql>
        <rollback>
            DELETE FROM mtsm.okei;
        </rollback>
    </changeSet>
    <changeSet author="d.zaitsev" id="20170829-2">
        <comment>таблица групп контрагентов</comment>
        <sql>
            CREATE TABLE mtsm.contragents_groups (
            guid varchar(255) NOT NULL,
            last_editing_date timestamp NOT NULL,
            is_active bool NULL,
            group_guid varchar(255) NULL,
            group_name varchar(255) NULL,
            CONSTRAINT contragents_groups_pkey PRIMARY KEY (guid)
            );

            ALTER TABLE MTSM.contragents_groups owner to mt_user;
            GRANT SELECT, INSERT, UPDATE, DELETE ON MTSM.contragents_groups TO mt_user;
        </sql>
        <rollback>
            DROP TABLE MTSM.contragents_groups;
        </rollback>
    </changeSet>

    <changeSet author="d.zaitsev" id="20170829-1">
        <comment>таблица контрагентов</comment>
        <sql>
            CREATE TABLE mtsm.contragents (
            guid varchar(255) NOT NULL,
            last_editing_date timestamp NOT NULL,
            account varchar(255) NOT NULL,
            active bool NULL,
            address varchar(255) NOT NULL,
            alias varchar(255) NULL,
            bank varchar(255) NOT NULL,
            bik varchar(255) NOT NULL,
            "comment" varchar(255) NULL,
            inn varchar(255) NOT NULL,
            korr_account varchar(255) NOT NULL,
            kpp varchar(255) NULL,
            "name" varchar(255) NOT NULL,
            group_guid varchar(255) NOT NULL,
            CONSTRAINT contragents_pkey PRIMARY KEY (guid),
            CONSTRAINT fk_a11yn6gqyuak02lcanxbssl6g FOREIGN KEY (group_guid) REFERENCES mtsm.contragents_groups(guid)
            );

            ALTER TABLE MTSM.contragents owner to mt_user;
            GRANT SELECT, INSERT, UPDATE, DELETE ON MTSM.contragents TO mt_user;
        </sql>
        <rollback>
            DROP TABLE MTSM.contragents;
        </rollback>
    </changeSet>

    <changeSet author="d.zaitsev" id="20170829-3">
        <comment>таблица контрагентов доп столбцы</comment>
        <sql>
            ALTER TABLE MTSM.contragents ADD COLUMN phone varchar(100);
            ALTER TABLE MTSM.contragents ADD COLUMN email varchar(100);
            ALTER TABLE MTSM.contragents ADD COLUMN ogrn varchar(100);
            ALTER TABLE MTSM.contragents ADD COLUMN okpo varchar(100);
            ALTER TABLE MTSM.contragents ADD COLUMN okved varchar(100);
        </sql>
        <rollback>
            ALTER TABLE MTSM.contragents DROP COLUMN phone;
            ALTER TABLE MTSM.contragents DROP COLUMN email;
            ALTER TABLE MTSM.contragents DROP COLUMN ogrn;
            ALTER TABLE MTSM.contragents DROP COLUMN okpo;
            ALTER TABLE MTSM.contragents DROP COLUMN okved;
        </rollback>
    </changeSet>
    <changeSet author="d.zaitsev" id="20170831-1">
        <comment>таблица контрагенты грузоотправитель/грузополучатель</comment>
        <sql>
            ALTER TABLE MTSM.contragents ADD COLUMN contragent_type varchar(10);
            ALTER TABLE MTSM.contragents ADD COLUMN shipper varchar(100);
        </sql>
        <rollback>
            ALTER TABLE MTSM.contragents DROP COLUMN contragent_type;
            ALTER TABLE MTSM.contragents DROP COLUMN shipper;
        </rollback>
    </changeSet>
    <changeSet author="d.zaitsev" id="20170831-2">
        <comment>таблица контрагенты грузоотправитель/грузополучатель</comment>
        <sql>
            ALTER TABLE MTSM.contragents ADD COLUMN s_serie varchar(20);
            ALTER TABLE MTSM.contragents ADD COLUMN s_number varchar(20);
            ALTER TABLE MTSM.contragents ADD COLUMN s_vidan varchar(100);
            ALTER TABLE MTSM.contragents ADD COLUMN s_date timestamp;
            ALTER TABLE MTSM.contragents ADD COLUMN p_serie varchar(20);
            ALTER TABLE MTSM.contragents ADD COLUMN p_number varchar(20);
            ALTER TABLE MTSM.contragents ADD COLUMN p_vidan varchar(100);
            ALTER TABLE MTSM.contragents ADD COLUMN p_date timestamp;
        </sql>
        <rollback>
            ALTER TABLE MTSM.contragents DROP COLUMN s_serie;
            ALTER TABLE MTSM.contragents DROP COLUMN s_number;
            ALTER TABLE MTSM.contragents DROP COLUMN s_vidan;
            ALTER TABLE MTSM.contragents DROP COLUMN s_date;
            ALTER TABLE MTSM.contragents DROP COLUMN p_serie;
            ALTER TABLE MTSM.contragents DROP COLUMN p_number;
            ALTER TABLE MTSM.contragents DROP COLUMN p_vidan;
            ALTER TABLE MTSM.contragents DROP COLUMN p_date;
        </rollback>
    </changeSet>

    <changeSet author="d.zaitsev" id="20170831-2">
        <comment>таблица номера счета на оплату</comment>
        <sql>
            insert into mtsm.order_number (guid, last_editing_date, order_number) values (uuid_generate_v4(), current_date, 1);
        </sql>
        <rollback>
            delete from mtsm.order_number;
        </rollback>
    </changeSet>
</databaseChangeLog>